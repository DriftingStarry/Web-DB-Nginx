name: ssh-deploy
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: testdeploy
      uses: cross-the-world/ssh-scp-ssh-pipelines@latest
      env:
        LASTSSH: "Doing something after copying"
      with:
        host: ${{ secrets.ALYHOST }}
        user: ${{ secrets.ALYUSER }}
        pass: ${{ secrets.ALYPASS }}
        scp: |
          . => /home/dfsr/tmp/
        last_ssh: |
          echo $LASTSSH 
          cd /home/dfsr/
          docker compose -f ./compose/docker-compose.yml down --rmi all
          cp -r ./compose/MariaDb/data ./tmp/MariaDb/data
          if [ -d lastver ]; then
            echo ${{ secrets.ALYPASS }} | sudo -S rm -r lastver
          fi
          mv compose lastver
          mv tmp compose
          mkdir tmp
          docker compose -f ./compose/docker-compose.yml up -d
